<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Subbacultcha archive</title>
  <style>
    :root { --bar-h: 44px; }
    html, body { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .bar {
      position: fixed; top: 0; left: 0; right: 0;
      height: var(--bar-h);
      display: flex; align-items: center; gap: 10px;
      padding: 6px 10px;
      background: #111; color: #fff;
      z-index: 10;
      box-sizing: border-box;
    }
    .bar label { font-size: 12px; opacity: .85; }
    .bar select {
      max-width: min(520px, 70vw);
      width: 100%;
      height: 30px;
      border-radius: 6px;
      border: 1px solid #444;
      background: #1b1b1b;
      color: #fff;
      padding: 0 10px;
      outline: none;
    }
    .bar .status { font-size: 12px; opacity: .8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .frame-wrap {
      position: fixed;
      top: var(--bar-h);
      left: 0; right: 0; bottom: 0;
      background: #222;
    }
    iframe {
      width: 100%;
      height: 100%;
      border: 0;
      background: #fff;
    }
  </style>
</head>
<body>
  <div class="bar">
    <label for="issueSelect">Issue</label>
    <select id="issueSelect" aria-label="Select issue"></select>
    <div class="status" id="status"></div>
  </div>

  <div class="frame-wrap">
    <iframe id="viewer" referrerpolicy="no-referrer"></iframe>
  </div>

  <script>
    // ======= CONFIG =======
    // If you fork this repo, just change OWNER/REPO.
    const OWNER = "szaboat";
    const REPO  = "Subbacultcha-mailing-list-archive";
    // Folder names look like "2004-September" etc.
    const ISSUE_DIR_RE = /^\d{4}-[A-Za-z]+$/;

    const elSelect = document.getElementById("issueSelect");
    const elFrame  = document.getElementById("viewer");
    const elStatus = document.getElementById("status");

    function setStatus(msg) { elStatus.textContent = msg || ""; }

    function repoRootOnPages() {
      // e.g. /Subbacultcha-mailing-list-archive/...
      // We want the first path segment as the "site root" for project pages.
      const parts = location.pathname.split("/").filter(Boolean);
      const project = parts.length ? parts[0] : "";
      return location.origin + (project ? ("/" + project + "/") : "/");
    }

    function issueUrl(dir, subpath = "") {
      // Ensure iframe URL stays within the GitHub Pages site.
      const base = repoRootOnPages();
      // Load directory index (dir/) or a subpath within it.
      return new URL(dir.replace(/\/+$/,"") + "/" + subpath.replace(/^\/+/,""), base).toString();
    }

    function sortIssues(a, b) {
      // Sort by YYYY then month name (best-effort). If month names vary, fallback to alpha.
      // Most archives will still look fine even with alpha sorting within year.
      const [ya, ma] = a.split("-");
      const [yb, mb] = b.split("-");
      if (ya !== yb) return Number(ya) - Number(yb);
      return ma.localeCompare(mb);
    }

    function populateSelect(issueDirs) {
      elSelect.innerHTML = "";
      for (const dir of issueDirs) {
        const opt = document.createElement("option");
        opt.value = dir;
        opt.textContent = dir;
        elSelect.appendChild(opt);
      }
    }

    function setSelectedIssue(dir, pushState = true) {
      if (!dir) return;

      // Update select UI
      if (elSelect.value !== dir) elSelect.value = dir;

      // Load issue in iframe
      const url = issueUrl(dir);
      elFrame.src = url;

      // Update page URL ?issue=...
      const u = new URL(location.href);
      u.searchParams.set("issue", dir);
      if (pushState) history.pushState({}, "", u);
    }

    function pickInitialIssue(issueDirs) {
      const u = new URL(location.href);
      const wanted = u.searchParams.get("issue");
      if (wanted && issueDirs.includes(wanted)) return wanted;
      // Default: latest (last after sorting)
      return issueDirs[issueDirs.length - 1];
    }

    async function loadIssueDirsFromGitHub() {
      // GitHub REST: "Get repository content" (root listing when path omitted)
      const api = `https://api.github.com/repos/${OWNER}/${REPO}/contents/`;
      setStatus("Loading issues…");
      const res = await fetch(api, { headers: { "Accept": "application/vnd.github+json" } });
      if (!res.ok) throw new Error(`GitHub API error: ${res.status}`);
      const items = await res.json();

      const dirs = items
        .filter(x => x && x.type === "dir" && ISSUE_DIR_RE.test(x.name))
        .map(x => x.name)
        .sort(sortIssues);

      if (!dirs.length) throw new Error("No issue folders found.");
      return dirs;
    }

    // Optional: keep dropdown in sync if the user clicks a link that jumps to another issue folder.
    // This works because everything is same-origin on GitHub Pages.
    function syncSelectOnFrameLoad(issueDirs) {
      elFrame.addEventListener("load", () => {
        try {
          const href = elFrame.contentWindow.location.href;
          const base = repoRootOnPages();
          if (!href.startsWith(base)) return;

          const rel = href.slice(base.length); // e.g. "2004-April/somepage.html"
          const top = rel.split("/")[0];
          if (issueDirs.includes(top) && elSelect.value !== top) {
            // Replace state (don’t spam history while navigating inside iframe)
            const u = new URL(location.href);
            u.searchParams.set("issue", top);
            history.replaceState({}, "", u);
            elSelect.value = top;
          }
        } catch (e) {
          // If anything blocks access, just ignore.
        }
      });
    }

    (async function main() {
      try {
        const dirs = await loadIssueDirsFromGitHub();
        populateSelect(dirs);

        elSelect.addEventListener("change", () => setSelectedIssue(elSelect.value));
        const initial = pickInitialIssue(dirs);
        setSelectedIssue(initial, false);

        syncSelectOnFrameLoad(dirs);
        setStatus("");
      } catch (err) {
        console.error(err);
        setStatus("Couldn’t load issues. (GitHub API rate-limit or unexpected repo layout.)");
        // Fallback: you can hardcode a short list here if needed.
      }
    })();
  </script>
</body>
</html>
