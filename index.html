<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
  <title>Zozi's Subbacultcha</title>
  <style>
    :root { --bar-h: 44px; }
    html, body { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .bar {
      position: fixed; top: 0; left: 0; right: 0;
      height: var(--bar-h);
      display: flex; align-items: center; gap: 10px;
      padding: 6px 10px;
      background: #111; color: #fff;
      z-index: 10;
      box-sizing: border-box;
    }
    .bar label { font-size: 12px; opacity: .85; }
    .bar select {
      max-width: min(520px, 70vw);
      width: 100%;
      height: 30px;
      border-radius: 6px;
      border: 1px solid #444;
      background: #1b1b1b;
      color: #fff;
      padding: 0 10px;
      outline: none;
    }
    .bar .status { font-size: 12px; opacity: .8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
		.frame-wrap {
			position: fixed;
			top: var(--bar-h);
			left: 0; right: 0; bottom: 0;
			background: #222;
			display: flex;
			justify-content: center;
			align-items: flex-start;
			box-sizing: border-box;
		}
		iframe {
			max-width: 100vw;
			width: 100%;
			height: 100%;
			border: 0;
			background: #fff;
			display: block;
			margin: 0 auto;
		}
  </style>
</head>
<body>
  <div class="bar">
    <label for="issueSelect">Issue</label>
    <select id="issueSelect" aria-label="Select issue"></select>
    <div class="status" id="status"></div>
  </div>

  <div class="frame-wrap">
    <iframe id="viewer"></iframe>
  </div>

  <script>
    // Hardcoded source repo
    const SRC_OWNER = "szaboat";
    const SRC_REPO  = "Subbacultcha-mailing-list-archive";

    // Folder names look like: 2004-September
    const ISSUE_DIR_RE = /^\d{4}-[A-Za-z]+$/;

    const elSelect = document.getElementById("issueSelect");
    const elFrame  = document.getElementById("viewer");
    const elStatus = document.getElementById("status");

    function setStatus(msg) { elStatus.textContent = msg || ""; }

    function sortIssues(a, b) {
      const [ya, ma] = a.split("-");
      const [yb, mb] = b.split("-");
      if (ya !== yb) return Number(ya) - Number(yb);
      return ma.localeCompare(mb);
    }

    function srcPagesBase() {
      // Source repo GitHub Pages base (project pages):
      // https://szaboat.github.io/Subbacultcha-mailing-list-archive/
      return `https://${SRC_OWNER}.github.io/${SRC_REPO}/`;
    }

    function issueUrl(dir, subpath = "") {
      const base = srcPagesBase();
      return new URL(
        dir.replace(/\/+$/,"") + "/" + subpath.replace(/^\/+/,""),
        base
      ).toString();
    }

    function populateSelect(issueDirs) {
      elSelect.innerHTML = "";
      for (const dir of issueDirs) {
        const opt = document.createElement("option");
        opt.value = dir;
        opt.textContent = dir;
        elSelect.appendChild(opt);
      }
    }

    function setSelectedIssue(dir, pushState = true) {
      if (!dir) return;
      if (elSelect.value !== dir) elSelect.value = dir;

      elFrame.src = issueUrl(dir);

      const u = new URL(location.href);
      u.searchParams.set("issue", dir);
      if (pushState) history.pushState({}, "", u);
    }

    function pickInitialIssue(issueDirs) {
      const u = new URL(location.href);
      const wanted = u.searchParams.get("issue");
      if (wanted && issueDirs.includes(wanted)) return wanted;
      return issueDirs[issueDirs.length - 1]; // latest by sorting
    }

    async function loadIssueDirsFromGitHub() {
      // Repo root listing via GitHub REST contents API
      const api = `https://api.github.com/repos/${SRC_OWNER}/${SRC_REPO}/contents/`;
      setStatus("Loading issues…");

      const res = await fetch(api, { headers: { "Accept": "application/vnd.github+json" } });
      if (!res.ok) throw new Error(`GitHub API error: ${res.status}`);

      const items = await res.json();
      const dirs = items
        .filter(x => x && x.type === "dir" && ISSUE_DIR_RE.test(x.name))
        .map(x => x.name)
        .sort(sortIssues);

      if (!dirs.length) throw new Error("No issue folders found.");
      return dirs;
    }

    (async function main() {
      try {
        const dirs = await loadIssueDirsFromGitHub();
        populateSelect(dirs);

        elSelect.addEventListener("change", () => setSelectedIssue(elSelect.value));
        setSelectedIssue(pickInitialIssue(dirs), false);

        setStatus("");
      } catch (err) {
        console.error(err);
        setStatus("Couldn’t load issues (rate-limit or unexpected repo layout).");
      }
    })();
  </script>
</body>
</html>
